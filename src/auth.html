<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spotify Authentication</title>
    <style>
      /* ===== GLOBAL STYLES ===== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      ::-webkit-scrollbar {
        display: none;
      }

      /* ===== LAYOUT & TYPOGRAPHY ===== */
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont,
          "Helvetica Neue", sans-serif;
        background: linear-gradient(135deg, #121212 0%, #1a3c34 100%);
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        overflow: hidden;
        position: relative;
      }

      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: radial-gradient(
            circle at 30% 30%,
            rgba(29, 185, 84, 0.15),
            transparent 50%
          ),
          radial-gradient(
            circle at 70% 70%,
            rgba(29, 185, 84, 0.1),
            transparent 50%
          );
        opacity: 0.5;
        pointer-events: none;
      }

      /* ===== MAIN CONTAINER ===== */
      .auth-container {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 40px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        max-width: 360px;
        width: 90%;
        position: relative;
        z-index: 1;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .auth-container:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
      }

      /* ===== LOGO & BRANDING ===== */
      .spotify-logo {
        width: 64px;
        height: 64px;
        margin: 0 auto 20px;
        background: #1db954;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .spotify-logo:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 20px rgba(29, 185, 84, 0.4);
      }

      .spotify-logo svg {
        width: 32px;
        height: 32px;
        fill: #ffffff;
      }

      /* ===== TYPOGRAPHY ===== */
      .auth-title {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 12px;
        color: #ffffff;
      }

      .auth-subtitle {
        font-size: 14px;
        font-weight: 400;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 28px;
        line-height: 1.6;
      }

      /* ===== BUTTONS ===== */
      .login-button {
        background: #1db954;
        border: none;
        border-radius: 32px;
        padding: 14px 28px;
        font-size: 14px;
        font-weight: 600;
        color: #ffffff;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(29, 185, 84, 0.3);
        min-width: 180px;
        position: relative;
        overflow: hidden;
        font-family: inherit;
      }

      .login-button:hover {
        background: #1ed760;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(29, 185, 84, 0.4);
      }

      .login-button:active {
        transform: translateY(0);
        box-shadow: 0 4px 12px rgba(29, 185, 84, 0.3);
      }

      .login-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* ===== STATUS MESSAGES ===== */
      .status-message {
        margin-top: 20px;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s ease;
        opacity: 0;
        transform: translateY(8px);
      }

      .status-message.show {
        opacity: 1;
        transform: translateY(0);
      }

      .status-message.error {
        background: rgba(255, 69, 58, 0.15);
        border: 1px solid rgba(255, 69, 58, 0.2);
        color: #ff6b6b;
      }

      .status-message.success {
        background: rgba(29, 185, 84, 0.15);
        border: 1px solid rgba(29, 185, 84, 0.2);
        color: #1ed760;
      }

      .status-message.loading {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
      }

      /* ===== LOADING SPINNER ===== */
      .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #ffffff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 6px;
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* ===== FOOTER ===== */
      .auth-footer {
        margin-top: 28px;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.6);
        line-height: 1.5;
      }

      .auth-footer a {
        color: #1db954;
        text-decoration: none;
        transition: color 0.3s ease;
      }

      .auth-footer a:hover {
        color: #1ed760;
      }

      /* ===== ANIMATIONS ===== */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .auth-container {
        animation: fadeInUp 0.5s ease-out;
      }

      /* ===== RESPONSIVE DESIGN ===== */
      @media (max-width: 480px) {
        .auth-container {
          padding: 24px;
          width: 95%;
        }

        .auth-title {
          font-size: 20px;
        }

        .auth-subtitle {
          font-size: 13px;
        }

        .login-button {
          padding: 12px 24px;
          font-size: 13px;
          min-width: 160px;
        }
      }

      /* ===== SETTINGS BUTTON ===== */
      .settings-button {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 1000;
      }

      .settings-button svg {
        width: 20px;
        height: 20px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .settings-button:hover {
        background: rgba(29, 215, 96, 0.15);
        color: #1ed760;
        transform: scale(1.05) rotate(45deg);
        border-color: rgba(29, 215, 96, 0.3);
        box-shadow: 0 4px 20px rgba(29, 215, 96, 0.2);
      }

      .settings-button:active {
        background: rgba(29, 215, 96, 0.25);
        transform: scale(0.95) rotate(45deg);
      }

      .settings-icon {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .settings-button:hover .settings-icon {
        filter: drop-shadow(0 0 8px rgba(29, 215, 96, 0.5));
      }

      /* ===== INLINE SETTINGS PANEL ===== */
      .settings-panel {
        position: absolute;
        top: 70px;
        right: 20px;
        width: 400px;
        max-height: 500px;
        background: rgba(18, 18, 18, 0.95);
        border: 1px solid rgba(29, 185, 84, 0.3);
        border-radius: 12px;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        transform: translateY(-20px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1001;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      }

      .settings-panel.show {
        transform: translateY(0);
        opacity: 1;
        visibility: visible;
      }

      .settings-header {
        padding: 20px;
        border-bottom: 1px solid rgba(29, 185, 84, 0.3);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .settings-title {
        color: #1ed760;
        font-size: 18px;
        font-weight: 600;
        margin: 0;
      }

      .close-settings {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        font-size: 20px;
        padding: 5px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .close-settings:hover {
        color: #1ed760;
        background: rgba(29, 215, 96, 0.1);
      }

      .settings-content {
        padding: 20px;
      }

      .shortcut-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .shortcut-item:last-child {
        border-bottom: none;
      }

      .shortcut-label {
        color: #e0e0e0;
        font-size: 14px;
        font-weight: 500;
        flex: 1;
      }

      .shortcut-input {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        padding: 8px 12px;
        color: #e0e0e0;
        font-family: "Courier New", monospace;
        font-size: 12px;
        width: 150px;
        outline: none;
        transition: all 0.3s ease;
      }

      .shortcut-input:focus {
        border-color: #1ed760;
        background: rgba(29, 215, 96, 0.1);
      }

      .shortcut-input.recording {
        border-color: #ff4757;
        animation: pulse 1.2s infinite;
        background: rgba(255, 71, 87, 0.1);
      }

      .record-btn {
        background: rgba(29, 215, 96, 0.2);
        border: 1px solid rgba(29, 215, 96, 0.4);
        border-radius: 6px;
        color: #1ed760;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-left: 8px;
      }

      .record-btn:hover {
        background: rgba(29, 215, 96, 0.3);
        border-color: rgba(29, 215, 96, 0.6);
      }

      .record-btn.recording {
        background: rgba(255, 71, 87, 0.2);
        border-color: rgba(255, 71, 87, 0.4);
        color: #ff4757;
      }

      .settings-actions {
        padding: 20px;
        border-top: 1px solid rgba(29, 185, 84, 0.3);
        display: flex;
        gap: 12px;
      }

      .settings-btn {
        flex: 1;
        padding: 10px;
        border: 1px solid rgba(29, 185, 84, 0.4);
        border-radius: 8px;
        background: rgba(29, 185, 84, 0.1);
        color: #1ed760;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .settings-btn:hover {
        background: rgba(29, 185, 84, 0.2);
        border-color: rgba(29, 185, 84, 0.6);
      }

      .settings-btn.reset {
        background: rgba(255, 71, 87, 0.1);
        border-color: rgba(255, 71, 87, 0.4);
        color: #ff4757;
      }

      .settings-btn.reset:hover {
        background: rgba(255, 71, 87, 0.2);
        border-color: rgba(255, 71, 87, 0.6);
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Responsive adjustments */
      @media (max-width: 800px) {
        .settings-panel {
          right: 10px;
          left: 10px;
          width: auto;
        }
      }

      @media (max-height: 600px) {
        .settings-panel {
          max-height: 400px;
          top: 60px;
        }
      }
    </style>
  </head>
  <body>
    <button class="settings-button" id="settings-button" title="Settings">
      <svg class="settings-icon" viewBox="0 0 24 24" fill="currentColor">
        <path
          d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11.03L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11.03C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"
        />
      </svg>
    </button>
    <div class="auth-container">
      <div class="spotify-logo">
        <svg viewBox="0 0 168 168" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M83.996 0C37.747 0 0 37.747 0 83.996c0 46.251 37.747 83.996 83.996 83.996 46.251 0 83.996-37.747 83.996-83.996C167.992 37.747 130.247 0 83.996 0zm38.622 121.176c-1.508 2.47-4.729 3.245-7.201 1.739-19.735-12.061-44.607-14.794-73.87-8.103-2.825 0.646-5.653-1.317-6.297-4.142-0.646-2.825 1.317-5.653 4.142-6.297 32.205-7.356 59.847-4.181 81.971 9.382 2.47 1.508 3.245 4.729 1.737 7.201zm10.288-22.903c-1.898 3.091-5.939 4.065-9.031 2.166-22.582-13.889-56.994-17.906-83.709-9.789-3.637 1.105-7.482-0.951-8.588-4.588-1.105-3.637 0.951-7.482 4.588-8.588 30.413-9.242 68.222-4.758 94.585 11.135 3.091 1.898 4.065 5.939 2.166 9.031zm0.883-23.848c-27.058-16.061-71.717-17.548-97.567-9.706-4.381 1.33-9.007-1.144-10.336-5.525-1.33-4.381 1.144-9.007 5.525-10.336 29.581-8.98 78.756-7.245 109.83 10.998 3.7 2.176 4.919 6.912 2.743 10.612-2.176 3.7-6.912 4.919-10.612 2.743z"
          />
        </svg>
      </div>

      <h1 class="auth-title">Connect to Spotify</h1>
      <p class="auth-subtitle">
        Sign in with your Spotify account to control your music playback
      </p>

      <button
        class="login-button"
        id="login-btn"
        onclick="authenticateSpotify()"
      >
        <span id="button-text">Connect with Spotify</span>
      </button>

      <div class="status-message" id="status-message"></div>

      <div class="auth-footer">
        <p>
          We only access your currently playing track and playback controls.<br />
          <strong>Note:</strong> Spotify Premium is required for playback
          control.<br />
          <a
            href="https://developer.spotify.com/documentation/general/guides/authorization/scopes/"
            target="_blank"
          >
            Learn more about permissions
          </a>
        </p>
      </div>
    </div>

    <!-- Inline Settings Panel -->
    <div class="settings-panel" id="settings-panel">
      <div class="settings-header">
        <h3 class="settings-title">Global Shortcuts</h3>
        <button class="close-settings" id="close-settings">Ã—</button>
      </div>

      <div class="settings-content">
        <div class="shortcut-item">
          <span class="shortcut-label">Toggle Window</span>
          <div>
            <input
              type="text"
              class="shortcut-input"
              id="toggleWindow"
              readonly
            />
            <button class="record-btn" data-shortcut="toggleWindow">
              Record
            </button>
          </div>
        </div>

        <div class="shortcut-item">
          <span class="shortcut-label">Play/Pause</span>
          <div>
            <input type="text" class="shortcut-input" id="playPause" readonly />
            <button class="record-btn" data-shortcut="playPause">Record</button>
          </div>
        </div>

        <div class="shortcut-item">
          <span class="shortcut-label">Next Track</span>
          <div>
            <input type="text" class="shortcut-input" id="nextTrack" readonly />
            <button class="record-btn" data-shortcut="nextTrack">Record</button>
          </div>
        </div>

        <div class="shortcut-item">
          <span class="shortcut-label">Previous Track</span>
          <div>
            <input
              type="text"
              class="shortcut-input"
              id="previousTrack"
              readonly
            />
            <button class="record-btn" data-shortcut="previousTrack">
              Record
            </button>
          </div>
        </div>

        <div class="shortcut-item">
          <span class="shortcut-label">Volume Up</span>
          <div>
            <input type="text" class="shortcut-input" id="volumeUp" readonly />
            <button class="record-btn" data-shortcut="volumeUp">Record</button>
          </div>
        </div>

        <div class="shortcut-item">
          <span class="shortcut-label">Volume Down</span>
          <div>
            <input
              type="text"
              class="shortcut-input"
              id="volumeDown"
              readonly
            />
            <button class="record-btn" data-shortcut="volumeDown">
              Record
            </button>
          </div>
        </div>

        <div class="shortcut-item">
          <span class="shortcut-label">Mute/Unmute</span>
          <div>
            <input type="text" class="shortcut-input" id="mute" readonly />
            <button class="record-btn" data-shortcut="mute">Record</button>
          </div>
        </div>
      </div>

      <div class="settings-actions">
        <button class="settings-btn" id="save-settings">Save Settings</button>
        <button class="settings-btn reset" id="reset-settings">
          Reset to Defaults
        </button>
      </div>
    </div>

    <script>
      let isAuthenticating = false;

      function showStatus(message, type = "loading") {
        const statusEl = document.getElementById("status-message");
        statusEl.textContent = message;
        statusEl.className = `status-message ${type} show`;
      }

      function hideStatus() {
        const statusEl = document.getElementById("status-message");
        statusEl.classList.remove("show");
      }

      function setButtonLoading(loading) {
        const button = document.getElementById("login-btn");
        const buttonText = document.getElementById("button-text");

        if (loading) {
          button.disabled = true;
          buttonText.innerHTML = '<span class="spinner"></span>Connecting...';
        } else {
          button.disabled = false;
          buttonText.textContent = "Connect with Spotify";
        }
      }

      async function authenticateSpotify() {
        if (isAuthenticating) return;

        isAuthenticating = true;
        setButtonLoading(true);
        showStatus("Connecting to Spotify...", "loading");

        // TEST DIFFERENT ERROR CONDITIONS (uncomment to test):

        // Test 1: Simulate network error
        // setTimeout(() => {
        //   showStatus("Network error. Please check your connection.", "error");
        //   setButtonLoading(false);
        //   isAuthenticating = false;
        //   setTimeout(hideStatus, 5000);
        // }, 2000);
        // return;

        // Test 2: Simulate invalid credentials
        // setTimeout(() => {
        //   showStatus("Invalid Spotify credentials. Please check your app settings.", "error");
        //   setButtonLoading(false);
        //   isAuthenticating = false;
        //   setTimeout(hideStatus, 5000);
        // }, 2000);
        // return;

        // Test 3: Simulate timeout
        // setTimeout(() => {
        //   showStatus("Authentication timed out. Please try again.", "error");
        //   setButtonLoading(false);
        //   isAuthenticating = false;
        //   setTimeout(hideStatus, 5000);
        // }, 5000);
        // return;

        try {
          const result = await window.electronAPI.authenticate();

          if (result.success) {
            showStatus(
              "Successfully connected! Launching player...",
              "success"
            );
            setTimeout(() => {
              window.electronAPI.closeAuthWindow();
            }, 3000);
          } else {
            throw new Error(result.error || "Authentication failed");
          }
        } catch (error) {
          console.error("Authentication error:", error);
          showStatus(
            error.message || "Failed to connect. Please try again.",
            "error"
          );
          setButtonLoading(false);
          setTimeout(hideStatus, 5000);
        } finally {
          isAuthenticating = false;
        }
      }

      document.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !isAuthenticating) {
          authenticateSpotify();
        }
      });

      window.addEventListener("load", () => {
        document.getElementById("login-btn").focus();
      });

      // Settings functionality
      let currentRecording = null;
      let recordingTimeout = null;
      let currentSettings = {};

      document.addEventListener("DOMContentLoaded", () => {
        const settingsButton = document.getElementById("settings-button");
        const settingsPanel = document.getElementById("settings-panel");
        const closeSettings = document.getElementById("close-settings");
        const saveSettings = document.getElementById("save-settings");
        const resetSettings = document.getElementById("reset-settings");

        // Toggle settings panel
        if (settingsButton) {
          settingsButton.addEventListener("click", async () => {
            if (settingsPanel.classList.contains("show")) {
              settingsPanel.classList.remove("show");
            } else {
              await loadSettings();
              settingsPanel.classList.add("show");
            }
          });
        }

        // Close settings panel
        if (closeSettings) {
          closeSettings.addEventListener("click", () => {
            settingsPanel.classList.remove("show");
          });
        }

        // Close settings when clicking outside
        document.addEventListener("click", (event) => {
          if (
            settingsPanel.classList.contains("show") &&
            !settingsPanel.contains(event.target) &&
            !settingsButton.contains(event.target)
          ) {
            settingsPanel.classList.remove("show");
          }
        });

        // Save settings
        if (saveSettings) {
          saveSettings.addEventListener("click", async () => {
            await saveSettingsData();
          });
        }

        // Reset settings
        if (resetSettings) {
          resetSettings.addEventListener("click", async () => {
            await resetSettingsData();
          });
        }

        // Set up record buttons
        document.querySelectorAll(".record-btn").forEach((button) => {
          button.addEventListener("click", () => {
            const shortcut = button.dataset.shortcut;
            recordShortcut(shortcut);
          });
        });

        // Handle keyboard input during recording
        document.addEventListener("keydown", handleKeyDown);
        document.addEventListener("keyup", handleKeyUp);
      });

      async function loadSettings() {
        try {
          if (window.electronAPI && window.electronAPI.getSettings) {
            const settings = await window.electronAPI.getSettings();
            currentSettings = settings;

            // Populate shortcut inputs
            const shortcuts = settings.shortcuts || {};
            Object.keys(shortcuts).forEach((key) => {
              const input = document.getElementById(key);
              if (input) {
                input.value = shortcuts[key] || "";
              }
            });
          }
        } catch (error) {
          console.error("Error loading settings:", error);
        }
      }

      function recordShortcut(actionKey) {
        // Stop any current recording
        if (currentRecording) {
          stopRecording();
        }

        const input = document.getElementById(actionKey);
        const button = input.parentElement.querySelector(".record-btn");

        if (!input || !button) return;

        // Start recording
        currentRecording = actionKey;
        input.classList.add("recording");
        button.classList.add("recording");
        button.textContent = "Recording...";
        input.value = "Press keys...";
        input.focus();

        // Set timeout to stop recording after 10 seconds
        recordingTimeout = setTimeout(() => {
          stopRecording();
        }, 10000);
      }

      function stopRecording() {
        if (!currentRecording) return;

        const input = document.getElementById(currentRecording);
        const button = input.parentElement.querySelector(".record-btn");

        if (input && button) {
          input.classList.remove("recording");
          button.classList.remove("recording");
          button.textContent = "Record";

          // Restore previous value if recording was cancelled
          if (input.value === "Press keys..." || input.value === "") {
            const shortcuts = currentSettings.shortcuts || {};
            input.value = shortcuts[currentRecording] || "";
          }
        }

        if (recordingTimeout) {
          clearTimeout(recordingTimeout);
          recordingTimeout = null;
        }

        currentRecording = null;
      }

      function handleKeyDown(event) {
        if (!currentRecording) return;

        event.preventDefault();
        event.stopPropagation();

        const keys = [];

        // Add modifier keys in consistent order
        if (event.ctrlKey || event.metaKey) {
          keys.push(
            process.platform === "darwin"
              ? "CommandOrControl"
              : "CommandOrControl"
          );
        }
        if (event.shiftKey) keys.push("Shift");
        if (event.altKey) keys.push("Alt");

        // Handle special keys
        let keyName = event.key;
        if (event.key === "ArrowUp") keyName = "Up";
        else if (event.key === "ArrowDown") keyName = "Down";
        else if (event.key === "ArrowLeft") keyName = "Left";
        else if (event.key === "ArrowRight") keyName = "Right";
        else if (event.key === " ") keyName = "Space";
        else if (event.key.length === 1) keyName = event.key.toUpperCase();

        // Don't add modifier keys as the main key
        if (
          !["Control", "Alt", "Shift", "Meta", "Cmd", "Command"].includes(
            keyName
          )
        ) {
          keys.push(keyName);
        }

        if (
          keys.length > 0 &&
          keys[keys.length - 1] !== "Shift" &&
          keys[keys.length - 1] !== "Alt" &&
          keys[keys.length - 1] !== "CommandOrControl"
        ) {
          const shortcut = keys.join("+");
          const input = document.getElementById(currentRecording);
          if (input) {
            input.value = shortcut;
          }
        }
      }

      function handleKeyUp(event) {
        if (!currentRecording) return;

        // Stop recording when all keys are released
        if (
          !event.ctrlKey &&
          !event.altKey &&
          !event.shiftKey &&
          !event.metaKey
        ) {
          setTimeout(() => {
            if (currentRecording) {
              stopRecording();
            }
          }, 100);
        }
      }

      async function saveSettingsData() {
        try {
          const shortcuts = {};

          // Collect all shortcut values
          [
            "toggleWindow",
            "playPause",
            "nextTrack",
            "previousTrack",
            "volumeUp",
            "volumeDown",
            "mute",
          ].forEach((key) => {
            const input = document.getElementById(key);
            if (input && input.value.trim()) {
              shortcuts[key] = input.value.trim();
            }
          });

          const settingsData = {
            shortcuts: shortcuts,
          };

          if (window.electronAPI && window.electronAPI.saveSettings) {
            await window.electronAPI.saveSettings(settingsData);

            // Show success feedback
            const saveButton = document.getElementById("save-settings");
            const originalText = saveButton.textContent;
            saveButton.textContent = "Saved!";
            saveButton.style.background = "rgba(29, 185, 84, 0.3)";

            setTimeout(() => {
              saveButton.textContent = originalText;
              saveButton.style.background = "";
            }, 2000);
          }
        } catch (error) {
          console.error("Error saving settings:", error);
        }
      }

      async function resetSettingsData() {
        try {
          if (window.electronAPI && window.electronAPI.resetSettings) {
            await window.electronAPI.resetSettings();
            await loadSettings();

            // Show success feedback
            const resetButton = document.getElementById("reset-settings");
            const originalText = resetButton.textContent;
            resetButton.textContent = "Reset!";

            setTimeout(() => {
              resetButton.textContent = originalText;
            }, 2000);
          }
        } catch (error) {
          console.error("Error resetting settings:", error);
        }
      }
    </script>
  </body>
</html>
